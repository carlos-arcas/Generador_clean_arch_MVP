"""ImplementaciÃ³n JSON del repositorio de Cliente."""

from __future__ import annotations

import json
import logging
from pathlib import Path
import tempfile

from aplicacion.puertos.repositorio_cliente import RepositorioCliente
from dominio.entidades.cliente import Cliente

LOGGER = logging.getLogger(__name__)


class RepositorioClienteJson(RepositorioCliente):
    def __init__(self, ruta_base: str) -> None:
        self._ruta_archivo = Path(ruta_base) / "datos" / "clientes.json"
        self._ruta_archivo.parent.mkdir(parents=True, exist_ok=True)
        if not self._ruta_archivo.exists():
            self._escribir_datos([])

    def crear(self, entidad: Cliente) -> Cliente:
        datos = self._leer_datos()
        nuevo_id = max((item.get("id", 0) for item in datos), default=0) + 1
        entidad_persistida = Cliente(**{**entidad.__dict__, "id": nuevo_id})
        datos.append(entidad_persistida.__dict__)
        self._escribir_datos(datos)
        LOGGER.info("Cliente creada id=%s", nuevo_id)
        return entidad_persistida

    def obtener_por_id(self, entidad_id: int) -> Cliente:
        for item in self._leer_datos():
            if item.get("id") == entidad_id:
                return Cliente(**item)
        raise ValueError("Cliente no encontrado")

    def listar(self) -> list[Cliente]:
        return [Cliente(**item) for item in self._leer_datos()]

    def actualizar(self, entidad: Cliente) -> Cliente:
        datos = self._leer_datos()
        for indice, item in enumerate(datos):
            if item.get("id") == entidad.id:
                datos[indice] = entidad.__dict__
                self._escribir_datos(datos)
                LOGGER.info("Cliente actualizada id=%s", entidad.id)
                return entidad
        raise ValueError("Cliente no encontrado")

    def eliminar(self, entidad_id: int) -> None:
        datos = self._leer_datos()
        filtrados = [item for item in datos if item.get("id") != entidad_id]
        if len(filtrados) == len(datos):
            raise ValueError("Cliente no encontrado")
        self._escribir_datos(filtrados)
        LOGGER.info("Cliente eliminada id=%s", entidad_id)

    def _leer_datos(self) -> list[dict]:
        contenido = self._ruta_archivo.read_text(encoding="utf-8").strip()
        if not contenido:
            return []
        return json.loads(contenido)

    def _escribir_datos(self, datos: list[dict]) -> None:
        descriptor, ruta_tmp = tempfile.mkstemp(
            dir=str(self._ruta_archivo.parent),
            prefix=f".{self._ruta_archivo.name}.",
            suffix=".tmp",
        )
        ruta_tmp_path = Path(ruta_tmp)
        try:
            with open(descriptor, "w", encoding="utf-8", closefd=True) as archivo_tmp:
                json.dump(datos, archivo_tmp, ensure_ascii=False, indent=2)
                archivo_tmp.write("\n")
            ruta_tmp_path.replace(self._ruta_archivo)
        finally:
            if ruta_tmp_path.exists():
                ruta_tmp_path.unlink()
